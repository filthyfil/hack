# Hack Platform - Jack Language Compiler & VM & Assembler & OS (std lib)

A complete implementation of the Hack platform from "The Elements of Computing Systems" (Nand2Tetris), including a Jack language compiler, VM translator, assembler, and OS.

## Quickstart

### Prerequisites
- C++17 or later (for `std::filesystem` support)
- GCC or compatible C++ compiler

### Building the Tools

1. **Build the compiler:**
   ```bash
   cd compiler
   g++ -std=c++17 -o ../j JackCompiler.cpp JackTokenizer.cpp CompilationEngine.cpp VMWriter.cpp SymbolTable.cpp TokenUtils.cpp
   cd ..
   ```

2. **Build the VM translator:**
   ```bash
   cd VM
   g++ -std=c++17 -o VirtualMachine VirtualMachine.cpp
   cd ..
   ```

3. **Build the assembler:**
   ```bash
   cd assembler
   g++ -std=c++17 -o Assembler Assembler.cpp
   cd ..
   ```

### Compiling a Program

The easiest way to build a complete program is using the `build.sh` script:

```bash
# Build a program (directory or single .jack file)
./build.sh compiler/test_programs/Pong

# Output will be in build/o.hack
```

## Quick Programming

For quick testing and development, there's a `Main.jack` file in the project root that you can edit directly. This file provides a convenient starting point for writing and testing Jack programs without creating a new directory structure.

**Usage:**
```bash
# Edit Main.jack for quick programming
vim Main.jack  # or your preferred editor

# Build it directly
./build.sh Main.jack

# Output will be in build/o.hack
```

The `Main.jack` file comes with a simple example program (array averaging) that you can modify or replace with your own code. This is ideal for:
- Quick prototyping
- Testing language features
- Learning the Jack language
- Small programs that don't need multiple files

## Important Notes

### VM Implementation Optimizations

**⚠️ The VM translator implementation currently needs optimizations to fit larger programs into the hardware platform.**

- **Pong compiles to approximately 55KB** of assembly code, which exceeds the RAM32K limit (32,768 words)
- The build system includes an assembly trimming tool (`tools/trim_asm.py`) that removes unreachable code, reducing Pong to ~30KB
- However, further optimizations in the VM translator itself would be beneficial:
  - Function call sequences could be optimized
  - Push/pop operations could use fewer instructions
  - Function initialization loops could be optimized

## Scripts

### `build.sh` - Build Script

Builds a complete Jack program from source to machine code.

**Usage:**
```bash
./build.sh [JACK_SOURCE]
./build.sh clean
```

**Arguments:**
- `JACK_SOURCE` - Path to a `.jack` file or directory containing `.jack` files (default: current directory)
- `clean` - Remove the `build/` directory

**Environment Variables:**
- `INCLUDE_OS` - Set to `0` to skip copying OS `.vm` files (default: `1`)
  ```bash
  INCLUDE_OS=0 ./build.sh compiler/test_programs/Seven
  ```

**Build Process:**
1. Copies `.jack` files to `build/src/`
2. Optionally copies OS `.vm` files (if `INCLUDE_OS=1`)
3. Compiles Jack sources to `.vm` files
4. Translates VM code to assembly (`.asm`)
4.5. [CURRENTLY REMOVED] Optionally trims unreachable code (if `tools/trim_asm.py` exists)
6. Assembles to machine code (`.hack`)
7. Outputs final file to `build/o.hack`

**Example:**
```bash
# Build Pong game
./build.sh compiler/test_programs/Pong

# Build without OS (smaller output)
INCLUDE_OS=0 ./build.sh compiler/test_programs/Seven

# Clean build directory
./build.sh clean
```

### `clean.sh` - XML Cleanup Script

Removes XML output files generated by the compiler (used for debugging/development).

**Usage:**
```bash
./clean.sh [OPTIONS] [TARGET_DIR]
```

**Options:**
- `-n, --dry-run` - Show files that would be deleted (default)
- `-f, --force` - Delete without interactive confirmation
- `-h, --help` - Show help message

**Arguments:**
- `TARGET_DIR` - Directory to search for XML files (default: current directory)

**Safety Features:**
- Only deletes files within the repository
- Dry-run mode by default (shows what would be deleted)
- Interactive confirmation required (unless `--force` is used)

**Example:**
```bash
# See what XML files would be deleted
./clean.sh

# Delete XML files in a specific directory
./clean.sh compiler/test_programs/Pong

# Force delete without confirmation
./clean.sh --force
```

## Compiler Usage

### Basic Usage

The compiler (`j` or `JackCompiler`) compiles Jack source files to VM code.

**Usage:**
```bash
./j <source> [--xml]
```

**Arguments:**
- `<source>` - Either:
  - A single `.jack` file, or
  - A directory containing one or more `.jack` files
- `--xml` - (Optional) Generate XML output files for debugging

### Default Behavior (without `--xml`)

By default, the compiler:
- **Only generates `.vm` files** (VM code output)
- Processes all `.jack` files in the source directory
- Outputs `.vm` files alongside the source `.jack` files
- Does **not** generate XML files

**Example:**
```bash
# Compile all .jack files in a directory
./j compiler/test_programs/Pong

# Output: Creates .vm files next to each .jack file
# - Main.vm
# - Ball.vm
# - Bat.vm
# - PongGame.vm
```

### XML Output Mode (`--xml` flag)

When the `--xml` flag is used, the compiler generates additional XML files for debugging:

**Generated Files:**
- `XxxT.xml` - Tokenizer XML output (shows tokenization process)
- `Xxx.xml` - Compilation XML output (shows parse tree structure)

**Use Cases:**
- Debugging compilation issues
- Understanding the parsing process
- Verifying tokenization correctness
- Educational purposes

**Example:**
```bash
# Compile with XML output
./j compiler/test_programs/Pong --xml

# Output files:
# - Main.jack (source)
# - Main.vm (VM code)
# - MainT.xml (tokenizer output)
# - Main.xml (compilation tree)
```

**Cleaning XML Files:**
After generating XML files, use `clean.sh` to remove them:
```bash
./clean.sh compiler/test_programs/Pong
```

## Project Structure

```
hack/
├── assembler/          # Hack assembler (ASM -> machine code)
├── compiler/           # Jack compiler (Jack -> VM)
│   ├── test_programs/  # Example programs
│   └── ...
├── VM/                 # VM translator (VM -> ASM)
├── OS/                 # Operating system (pre-compiled .vm files)
├── tools/              # Utility scripts (trim_asm.py)
├── build.sh            # Build script
├── clean.sh            # XML cleanup script
├── Main.jack           # Quick programming file (edit for quick testing)
└── j                   # Compiler executable
```

## Example Programs

The `compiler/test_programs/` directory contains several example programs:

- **Pong** - Full Pong game (requires optimizations to fit in RAM32K)
- **Square** - Simple square drawing program
- **Average** - Array averaging program
- **Seven** - Simple program
- **ComplexArrays** - Array manipulation examples
- **ConvertToBin** - Binary conversion utility

